import org.apache.sling.api.resource.Resource;
import org.apache.sling.api.resource.ResourceResolver;
import org.apache.sling.api.resource.ResourceResolverFactory;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Reference;
import com.adobe.cq.dam.cfm.ContentFragment;
import com.adobe.cq.dam.cfm.ContentElement;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import java.util.HashMap;
import java.util.Iterator;
import java.util.Map;

@Component(service = YourService.class)
public class YourService {

    private static final Logger log = LoggerFactory.getLogger(YourService.class);

    @Reference
    private ResourceResolverFactory resolverFactory;

    public void getContentFragmentContent(String cfPath) {
        ResourceResolver resourceResolver = null;
        try {
            // Obtain a ResourceResolver with appropriate privileges
            Map<String, Object> authInfo = new HashMap<>();
            authInfo.put(ResourceResolverFactory.SUBSERVICE, "your-service-user");
            resourceResolver = resolverFactory.getServiceResourceResolver(authInfo);

            // Get the Resource at the Content Fragment path
            Resource cfResource = resourceResolver.getResource(cfPath);

            if (cfResource != null) {
                // Adapt the Resource to a ContentFragment
                ContentFragment contentFragment = cfResource.adaptTo(ContentFragment.class);

                if (contentFragment != null) {
                    // Access elements within the ContentFragment
                    Iterator<ContentElement> elements = contentFragment.getElements();
                    while (elements.hasNext()) {
                        ContentElement element = elements.next();
                        String elementName = element.getName();
                        String elementValue = element.getValue().getString();

                        // Process the content as needed
                        log.info("Element Name: {}, Element Value: {}", elementName, elementValue);
                    }
                } else {
                    log.warn("Resource at path {} is not a Content Fragment", cfPath);
                }
            } else {
                log.warn("Resource not found at path: {}", cfPath);
            }
        } catch (Exception e) {
            log.error("Error retrieving content fragment content", e);
        } finally {
            if (resourceResolver != null && resourceResolver.isLive()) {
                resourceResolver.close();
            }
        }
    }
}
